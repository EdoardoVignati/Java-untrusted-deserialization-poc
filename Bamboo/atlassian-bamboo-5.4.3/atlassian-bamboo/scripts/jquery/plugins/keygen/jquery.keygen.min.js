
(function(exp,$){
exp.KeyGenerator=function(){
var IGNORED_WORDS=["THE","A","AN","AS","AND","OF","OR"],
CHARACTER_MAP={},
getTotalLength=function(words){
return words.join("").length;
},
removeIgnoredWords=function(words){
return $.grep(words,function(word,index){
return $.inArray(word,IGNORED_WORDS)===-1;
});
},
createAcronym=function(words){
var result="";
$.each(words,function(i,word){
result+=word.charAt(0);
});
return result;
},
getFirstSyllable=function(word){
var pastVowel=false;
var i;
for(i=0;i<word.length;i++){
if(isVowelOrY(word[i])){
pastVowel=true;
}else{
if(pastVowel){
return word.substring(0,i+1);
}
}
}
return word;
},
isVowelOrY=function(c){
return c&&c.length===1&&c.search("[AEIOUY]")!==-1;
};
CHARACTER_MAP[199]="C";
CHARACTER_MAP[231]="c";
CHARACTER_MAP[252]="u";
CHARACTER_MAP[251]="u";
CHARACTER_MAP[250]="u";
CHARACTER_MAP[249]="u";
CHARACTER_MAP[233]="e";
CHARACTER_MAP[234]="e";
CHARACTER_MAP[235]="e";
CHARACTER_MAP[232]="e";
CHARACTER_MAP[226]="a";
CHARACTER_MAP[228]="a";
CHARACTER_MAP[224]="a";
CHARACTER_MAP[229]="a";
CHARACTER_MAP[225]="a";
CHARACTER_MAP[239]="i";
CHARACTER_MAP[238]="i";
CHARACTER_MAP[236]="i";
CHARACTER_MAP[237]="i";
CHARACTER_MAP[196]="A";
CHARACTER_MAP[197]="A";
CHARACTER_MAP[201]="E";
CHARACTER_MAP[230]="ae";
CHARACTER_MAP[198]="Ae";
CHARACTER_MAP[244]="o";
CHARACTER_MAP[246]="o";
CHARACTER_MAP[242]="o";
CHARACTER_MAP[243]="o";
CHARACTER_MAP[220]="U";
CHARACTER_MAP[255]="Y";
CHARACTER_MAP[214]="O";
CHARACTER_MAP[241]="n";
CHARACTER_MAP[209]="N";
return{
generateKey:function(name,options){
options=$.extend({},options);
var desiredKeyLength=(typeof options.desiredKeyLength=='number')?options.desiredKeyLength:4,
maxKeyLength=(typeof options.maxKeyLength=='number')?options.maxKeyLength:Infinity,
charBlacklistRegex=(typeof options.charBlacklistRegex!='undefined'?options.charBlacklistRegex:/[^a-zA-Z0-9]/g);
name=$.trim(name);
if(!name){
return"";
}
var filtered=[];
for(var i=0,ii=name.length;i<ii;i++){
var sub=CHARACTER_MAP[name.charCodeAt(i)];
filtered.push(sub?sub:name[i]);
}
name=filtered.join('');
var words=[];
$.each(name.split(/\s+/),function(i,word){
if(word){
word=word.replace(charBlacklistRegex,"");
word=word.toUpperCase();
word.length&&words.push(word);
}
});
if(desiredKeyLength&&getTotalLength(words)>desiredKeyLength){
words=removeIgnoredWords(words);
}
var key;
if(words.length==0){
key="";
}else if(words.length==1){
var word=words[0],
firstSyllable=getFirstSyllable(word);
if(maxKeyLength<word.length||
Math.abs(word.length-desiredKeyLength)>=Math.abs(firstSyllable.length-desiredKeyLength)){
key=firstSyllable;
}else{
key=word;
}
}else{
var totalLength=getTotalLength(words),
acronym=createAcronym(words);
if(maxKeyLength<totalLength||
Math.abs(totalLength-desiredKeyLength)>=Math.abs(acronym.length-desiredKeyLength)){
key=acronym;
}else{
key=words.join('');
}
}
if(maxKeyLength&&key.length>maxKeyLength){
key=key.substr(0,maxKeyLength);
}
return key;
}
};
};
var keyGenerator=exp.KeyGenerator();
$.fn.generateFrom=function($nameElement,options){
var defaultOptions={
desiredKeyLength:4,
maxKeyLength:10,
maxNameLength:30,
timeoutMS:100,
charBlacklistRegex:/[^a-zA-Z0-9]/g,
uppercase:true,
validationCallback:function(){
},
errorCallback:function(){
}
},
$keyElement=$(this).first(),
$nameElement=$nameElement.first(),
options=$.extend({},defaultOptions,options);
(function(){
var shouldUpdateKey=function(){
return $keyElement.data("autosuggest")!==false;
},
setKeyEdited=function(key){
if(key){
if($keyElement.data("lastGeneratedValue")!==key){
$keyElement.data("autosuggest",false);
}
}else{
$keyElement.data("autosuggest",true);
}
},
updateKey=function(key){
var oldKey=$keyElement.val();
$keyElement.data("lastGeneratedValue",key);
$keyElement.val(key);
return oldKey!=key;
},
onNameTimeout=function(){
setKeyEdited($keyElement.val());
autofillKeyIfNeeded();
},
bindNameHook=function(e){
bindHook(e,onNameTimeout);
},
bindHook=function(e,func){
var el=$(e.target),hook;
hook=function(){
unbindHook(e);
func();
if(el.is(":visible")){
el.data("checkHook",setTimeout(hook,options.timeoutMS));
}
};
if(!el.data("checkHook")){
el.data("checkHook",setTimeout(hook,0));
}
},
unbindHook=function(e){
var el=$(e.target);
clearTimeout(el.data("checkHook"));
el.removeData("checkHook");
},
autofillKeyIfNeeded=function(){
if(shouldUpdateKey()){
var key=keyGenerator.generateKey($nameElement.val(),{
desiredKeyLength:options.desiredKeyLength,
maxKeyLength:options.maxKeyLength,
charBlacklistRegex:options.charBlacklistRegex
});
if(updateKey(key)){
options.validationCallback();
}
}
};
$nameElement.attr("maxlength",options.maxNameLength);
$keyElement.attr("maxlength",options.maxKeyLength);
if(options.uppercase){
$keyElement.css("text-transform","uppercase");
}
if(document.activeElement&&document.activeElement===$nameElement[0]){
bindNameHook({target:$nameElement[0]});
}
$nameElement.focus(bindNameHook);
$nameElement.blur(unbindHook);
})();
return this;
};
})(window,jQuery);
